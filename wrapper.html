<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Course</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f0f0; }
        #container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
        #scorm-frame { flex: 1; border: none; width: 100%; background: white; }
        #debug { background: #2c3e50; color: white; padding: 10px; font-size: 11px; max-height: 120px; overflow-y: auto; }
        .log { padding: 2px 0; border-bottom: 1px solid #34495e; }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div id="container">
        <iframe id="scorm-frame"></iframe>
        <div id="debug"><div class="log info">Inizializzazione SCORM API...</div></div>
    </div>

<script>
// Configurazione
const SCORM_URL = './branding-vs-performance-foundations-of-digital-marketing-campaign-management-scorm12-jzWzrBLS/scormcontent/index.html';
const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/seedtag.com/s/AKfycbwTMMtmgf5soGkL48U5rR08X7MlchsTAOAEmzdhmWaYICAM6x6AxzhBj5rhPWEioopDCQ/exec';
const USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
const COURSE_ID = 'branding-foundations';

// Logger
function log(msg, type) {
    const debug = document.getElementById('debug');
    const entry = document.createElement('div');
    entry.className = 'log ' + (type || 'info');
    entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    debug.appendChild(entry);
    debug.scrollTop = debug.scrollHeight;
    console.log('[SCORM] ' + msg);
}

// SCORM API 1.2
function ScormAPI() {
    this.data = {
        'cmi.core.student_id': USER_ID,
        'cmi.core.student_name': 'Student',
        'cmi.core.lesson_location': '',
        'cmi.core.lesson_status': 'not attempted',
        'cmi.core.score.raw': '',
        'cmi.core.score.max': '100',
        'cmi.core.score.min': '0',
        'cmi.core.total_time': '0000:00:00.00',
        'cmi.core.session_time': '0000:00:00.00',
        'cmi.suspend_data': ''
    };
    this.initialized = false;
    this.terminated = false;
    this.errorCode = '0';
    this.startTime = null;
}

ScormAPI.prototype.LMSInitialize = function() {
    if (this.initialized) return 'false';
    this.initialized = true;
    this.startTime = new Date();
    log('✓ LMSInitialize', 'success');
    this.sendData('initialize', {});
    return 'true';
};

ScormAPI.prototype.LMSFinish = function() {
    if (!this.initialized || this.terminated) return 'false';
    this.terminated = true;
    log('✓ LMSFinish', 'success');
    this.sendData('terminate', this.data);
    return 'true';
};

ScormAPI.prototype.LMSGetValue = function(key) {
    if (!this.initialized) return '';
    const val = this.data[key] || '';
    log('GetValue: ' + key + ' = ' + val, 'info');
    return val;
};

ScormAPI.prototype.LMSSetValue = function(key, value) {
    if (!this.initialized) return 'false';
    this.data[key] = value;
    const critical = ['cmi.core.lesson_status', 'cmi.core.score.raw'];
    if (critical.includes(key)) {
        log('SetValue: ' + key + ' = ' + value + ' [TRACKED]', 'success');
        this.sendData('setValue', { element: key, value: value });
    } else {
        log('SetValue: ' + key + ' = ' + value, 'info');
    }
    return 'true';
};

ScormAPI.prototype.LMSCommit = function() {
    if (!this.initialized) return 'false';
    log('✓ LMSCommit', 'success');
    this.sendData('commit', this.data);
    return 'true';
};

ScormAPI.prototype.LMSGetLastError = function() {
    return this.errorCode;
};

ScormAPI.prototype.LMSGetErrorString = function(code) {
    return 'Error ' + code;
};

ScormAPI.prototype.LMSGetDiagnostic = function(code) {
    return 'Diagnostic for error ' + code;
};

ScormAPI.prototype.sendData = function(action, data) {
    fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            action: action,
            userId: USER_ID,
            courseId: COURSE_ID,
            timestamp: new Date().toISOString(),
            data: data
        })
    }).then(() => {
        log('→ Data sent: ' + action, 'success');
    }).catch(e => {
        log('✗ Send error: ' + e.message, 'error');
    });
};

// Crea API globale
window.API = new ScormAPI();
window.API_1484_11 = window.API; // Per SCORM 2004

log('✓ SCORM API creata', 'success');

// Carica contenuto
const frame = document.getElementById('scorm-frame');
frame.onload = function() {
    log('✓ Contenuto caricato', 'success');
    // Prova a iniettare API nell'iframe in modo aggressivo
    try {
        if (frame.contentWindow) {
            frame.contentWindow.API = window.API;
            frame.contentWindow.API_1484_11 = window.API;
            
            // Inietta anche nel documento dell'iframe
            if (frame.contentDocument) {
                frame.contentDocument.API = window.API;
            }
            
            // Forza la ricerca dell'API
            setTimeout(function() {
                if (frame.contentWindow.API) {
                    log('✓ API disponibile nell\'iframe', 'success');
                } else {
                    log('⚠ API non trovata nell\'iframe', 'error');
                }
            }, 500);
        }
    } catch(e) {
        log('⚠ CORS: ' + e.message, 'error');
    }
};
frame.src = SCORM_URL;
log('Caricamento: ' + SCORM_URL, 'info');

// Cleanup
window.onbeforeunload = function() {
    if (window.API.initialized && !window.API.terminated) {
        window.API.LMSFinish();
    }
};
</script>
</body>
</html>
