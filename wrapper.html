<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCORM Course</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #1a1a1a; }
    #container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    #scorm-frame { flex: 1; border: none; width: 100%; background: white; }
    #debug { background: #2c3e50; color: white; padding: 10px; font-size: 11px; max-height: 120px; overflow-y: auto; }
    .log { padding: 2px 0; border-bottom: 1px solid #34495e; font-family: monospace; }
    .success { color: #2ecc71; }
    .error { color: #e74c3c; }
    .info { color: #3498db; }
    .warning { color: #f39c12; }
  </style>
</head>
<body>
  <div id="container">
    <iframe id="scorm-frame" allow="same-origin scripts forms"></iframe>
    <div id="debug"><div class="log info">ðŸš€ Inizializzazione SCORM...</div></div>
  </div>

<script>
// CONFIG
const SCORM_URL = './branding-vs-performance-foundations-of-digital-marketing-campaign-management-scorm12-jzWzrBLS/scormcontent/index.html';
const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/seedtag.com/s/AKfycbwTMMtmgf5soGkL48U5rR08X7MlchsTAOAEmzdhmWaYICAM6x6AxzhBj5rhPWEioopDCQ/exec';
const COURSE_ID = 'branding-foundations';

// LOGGING
function log(msg, type) {
  const debug = document.getElementById('debug');
  if (!debug) return;
  const entry = document.createElement('div');
  entry.className = 'log ' + (type || 'info');
  const icons = { success: 'âœ“', error: 'âœ—', warning: 'âš ', info: 'â†’' };
  entry.textContent = (icons[type] || 'â€¢') + ' ' + msg;
  debug.appendChild(entry);
  debug.scrollTop = debug.scrollHeight;
  console.log('[SCORM]', msg);
}

// USER ID
const USER_STORAGE_KEY = 'scorm_user_id_' + COURSE_ID;
let USER_ID = localStorage.getItem(USER_STORAGE_KEY);
if (!USER_ID) {
  USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem(USER_STORAGE_KEY, USER_ID);
}
log('USER: ' + USER_ID, 'info');

// TRACKING (GET request con pixel)
function trackEvent(action, extra) {
  extra = extra || {};
  const params = new URLSearchParams({
    action: action,
    userId: USER_ID,
    courseId: COURSE_ID,
    timestamp: new Date().toISOString(),
    lesson: extra.lesson || '',
    status: extra.status || '',
    score: extra.score != null ? String(extra.score) : ''
  });
  const img = new Image();
  img.src = APPS_SCRIPT_URL + '?' + params.toString();
  log('Track: ' + action, 'info');
}

// SCORM API 1.2
function ScormAPI() {
  this.storageKey = 'scorm_state_' + COURSE_ID + '_' + USER_ID;
  const defaultData = {
    'cmi.core.student_id': USER_ID,
    'cmi.core.student_name': 'Student',
    'cmi.core.lesson_location': '',
    'cmi.core.lesson_status': 'not attempted',
    'cmi.core.score.raw': '',
    'cmi.core.score.max': '100',
    'cmi.core.score.min': '0',
    'cmi.core.total_time': '0000:00:00.00',
    'cmi.core.session_time': '0000:00:00.00',
    'cmi.suspend_data': ''
  };
  let saved = null;
  try {
    const raw = localStorage.getItem(this.storageKey);
    if (raw) saved = JSON.parse(raw);
  } catch (e) {}
  this.data = saved ? Object.assign({}, defaultData, saved) : defaultData;
  this.initialized = false;
  this.terminated = false;
  this.errorCode = '0';
  this.startTime = null;
}

ScormAPI.prototype.saveState = function() {
  try {
    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
  } catch (e) {}
};

ScormAPI.prototype.LMSInitialize = function() {
  if (this.initialized) return 'false';
  this.initialized = true;
  this.startTime = new Date();
  log('Initialize', 'success');
  trackEvent('initialize');
  return 'true';
};

ScormAPI.prototype.LMSFinish = function() {
  if (!this.initialized || this.terminated) return 'false';
  this.terminated = true;
  this.saveState();
  log('Finish', 'success');
  return 'true';
};

ScormAPI.prototype.LMSGetValue = function(key) {
  if (!this.initialized) return '';
  return this.data[key] || '';
};

ScormAPI.prototype.LMSSetValue = function(key, value) {
  if (!this.initialized) return 'false';
  this.data[key] = value;
  this.saveState();
  return 'true';
};

ScormAPI.prototype.LMSCommit = function() {
  if (!this.initialized) return 'false';
  this.saveState();
  return 'true';
};

ScormAPI.prototype.LMSGetLastError = function() { return this.errorCode; };
ScormAPI.prototype.LMSGetErrorString = function() { return ''; };
ScormAPI.prototype.LMSGetDiagnostic = function() { return ''; };

// ESPONI API
window.API = new ScormAPI();
window.API_1484_11 = window.API;
log('API ready', 'success');

// ADAPTER RISE
const CHUNK_KEY = 'rise_chunk_' + COURSE_ID + '_' + USER_ID;
let lastChunk = localStorage.getItem(CHUNK_KEY) || '';

function GetDataChunk() {
  return window.API && window.API.initialized 
    ? window.API.LMSGetValue('cmi.suspend_data') 
    : lastChunk;
}

function SetDataChunk(chunk) {
  lastChunk = chunk || '';
  localStorage.setItem(CHUNK_KEY, lastChunk);
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.suspend_data', lastChunk);
  }
}

function SetScore(score, max, min) {
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.core.score.raw', score);
  }
  trackEvent('score', { score: score });
}

function SetReachedEnd() {
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.core.lesson_status', 'completed');
  }
  trackEvent('completed', { status: 'completed' });
}

function SetPassed() {
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.core.lesson_status', 'passed');
  }
  trackEvent('passed', { status: 'passed' });
}

function SetFailed() {
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.core.lesson_status', 'failed');
  }
  trackEvent('failed', { status: 'failed' });
}

function GetStatus() {
  return window.API && window.API.initialized
    ? window.API.LMSGetValue('cmi.core.lesson_status')
    : 'not attempted';
}

function SetBookmark(url, title) {
  if (window.API && window.API.initialized) {
    window.API.LMSSetValue('cmi.core.lesson_location', url || '');
  }
  trackEvent('bookmark', { lesson: url || '' });
}

function CommitData() {
  if (window.API && window.API.initialized) {
    window.API.LMSCommit('');
  }
}

function Finish() {
  if (window.API && window.API.initialized) {
    window.API.LMSFinish('');
  }
}

function GetStudentID() { return USER_ID; }
function ResetStatus() {}
function ConcedeControl() {}
function SetLanguagePreference() {}
function WriteToDebug() {}
function CreateResponseIdentifier() { return {}; }
function MatchingResponse() { return function() {}; }
function RecordMultipleChoiceInteraction() {}
function RecordMatchingInteraction() {}
function RecordFillInInteraction() {}

// Esponi
window.GetDataChunk = GetDataChunk;
window.SetDataChunk = SetDataChunk;
window.SetScore = SetScore;
window.SetReachedEnd = SetReachedEnd;
window.SetPassed = SetPassed;
window.SetFailed = SetFailed;
window.GetStatus = GetStatus;
window.SetBookmark = SetBookmark;
window.CommitData = CommitData;
window.Finish = Finish;
window.GetStudentID = GetStudentID;
window.ResetStatus = ResetStatus;
window.ConcedeControl = ConcedeControl;
window.SetLanguagePreference = SetLanguagePreference;
window.WriteToDebug = WriteToDebug;
window.CreateResponseIdentifier = CreateResponseIdentifier;
window.MatchingResponse = MatchingResponse;
window.RecordMultipleChoiceInteraction = RecordMultipleChoiceInteraction;
window.RecordMatchingInteraction = RecordMatchingInteraction;
window.RecordFillInInteraction = RecordFillInInteraction;

// IFRAME
const frame = document.getElementById('scorm-frame');

function injectAPI() {
  try {
    if (frame.contentWindow) {
      frame.contentWindow.API = window.API;
      frame.contentWindow.API_1484_11 = window.API;
      frame.contentWindow.findAPI = function() { return window.API; };
    }
  } catch (e) {}
}

frame.addEventListener('load', function() {
  log('Iframe loaded', 'success');
  injectAPI();
  setTimeout(injectAPI, 50);
  setTimeout(injectAPI, 200);
});

frame.src = SCORM_URL;
log('Loading course...', 'info');

window.addEventListener('beforeunload', function() {
  if (window.API && window.API.initialized && !window.API.terminated) {
    window.API.LMSFinish('');
  }
});
</script>
</body>
</html>
