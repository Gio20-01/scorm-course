<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Course</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; }
        #container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
        #scorm-frame { flex: 1; border: none; width: 100%; background: white; }
        #debug { background: #2c3e50; color: white; padding: 10px; font-size: 11px; max-height: 120px; overflow-y: auto; }
        .log { padding: 2px 0; border-bottom: 1px solid #34495e; font-family: monospace; }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .warning { color: #f39c12; }
    </style>
</head>
<body>
    <div id="container">
        <iframe id="scorm-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        <div id="debug"><div class="log info">ðŸš€ Inizializzazione SCORM Proxy...</div></div>
    </div>

<script>
const SCORM_URL = './branding-vs-performance-foundations-of-digital-marketing-campaign-management-scorm12-jzWzrBLS/scormcontent/index.html';
const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/seedtag.com/s/AKfycbwTMMtmgf5soGkL48U5rR08X7MlchsTAOAEmzdhmWaYICAM6x6AxzhBj5rhPWEioopDCQ/exec';
const USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
const COURSE_ID = 'branding-foundations';

function log(msg, type) {
    const debug = document.getElementById('debug');
    const entry = document.createElement('div');
    entry.className = 'log ' + (type || 'info');
    const icons = { success: 'âœ“', error: 'âœ—', warning: 'âš ', info: 'â†’' };
    entry.textContent = (icons[type] || 'â€¢') + ' ' + msg;
    debug.appendChild(entry);
    debug.scrollTop = debug.scrollHeight;
    console.log('[SCORM] ' + msg);
}

// SCORM API 1.2 con logging dettagliato
function ScormAPI() {
    this.data = {
        'cmi.core.student_id': USER_ID,
        'cmi.core.student_name': 'Student',
        'cmi.core.lesson_location': '',
        'cmi.core.lesson_status': 'not attempted',
        'cmi.core.score.raw': '',
        'cmi.core.score.max': '100',
        'cmi.core.score.min': '0',
        'cmi.core.total_time': '0000:00:00.00',
        'cmi.core.session_time': '0000:00:00.00',
        'cmi.suspend_data': '',
        'cmi.core.lesson_mode': 'normal',
        'cmi.core.exit': '',
        'cmi.core.entry': 'ab-initio'
    };
    this.initialized = false;
    this.terminated = false;
    this.errorCode = '0';
    this.startTime = null;
    log('API creata', 'success');
}

ScormAPI.prototype.LMSInitialize = function(param) {
    log('â†’ LMSInitialize chiamato', 'info');
    if (this.initialized) {
        log('GiÃ  inizializzato!', 'warning');
        return 'false';
    }
    this.initialized = true;
    this.startTime = new Date();
    log('âœ“ Sessione iniziata', 'success');
    this.sendData('initialize', {});
    return 'true';
};

ScormAPI.prototype.LMSFinish = function(param) {
    log('â†’ LMSFinish chiamato', 'info');
    if (!this.initialized || this.terminated) return 'false';
    this.terminated = true;
    log('âœ“ Sessione terminata', 'success');
    this.sendData('terminate', this.data);
    return 'true';
};

ScormAPI.prototype.LMSGetValue = function(key) {
    if (!this.initialized) {
        log('GetValue fallito: non inizializzato', 'error');
        return '';
    }
    const val = this.data[key] || '';
    log('GetValue: ' + key + ' = "' + val + '"', 'info');
    return val;
};

ScormAPI.prototype.LMSSetValue = function(key, value) {
    if (!this.initialized) {
        log('SetValue fallito: non inizializzato', 'error');
        return 'false';
    }
    this.data[key] = value;
    const critical = ['cmi.core.lesson_status', 'cmi.core.score.raw'];
    if (critical.includes(key)) {
        log('SetValue: ' + key + ' = "' + value + '" [TRACKED]', 'success');
        this.sendData('setValue', { element: key, value: value });
    } else {
        log('SetValue: ' + key + ' = "' + value + '"', 'info');
    }
    return 'true';
};

ScormAPI.prototype.LMSCommit = function(param) {
    if (!this.initialized) return 'false';
    log('âœ“ LMSCommit', 'success');
    this.sendData('commit', this.data);
    return 'true';
};

ScormAPI.prototype.LMSGetLastError = function() { return this.errorCode; };
ScormAPI.prototype.LMSGetErrorString = function(code) { return 'Error ' + code; };
ScormAPI.prototype.LMSGetDiagnostic = function(code) { return 'Diagnostic ' + code; };

ScormAPI.prototype.sendData = function(action, data) {
    fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            action: action,
            userId: USER_ID,
            courseId: COURSE_ID,
            timestamp: new Date().toISOString(),
            data: data
        })
    }).then(() => {
        log('Dati inviati: ' + action, 'success');
    }).catch(e => {
        log('Errore invio: ' + e.message, 'error');
    });
};

// Crea API GLOBALE prima di caricare l'iframe
window.API = new ScormAPI();
window.API_1484_11 = window.API;

log('API resa globale', 'success');

// Carica iframe con injection script
const frame = document.getElementById('scorm-frame');

// Quando l'iframe si carica, inietta l'API
frame.addEventListener('load', function() {
    log('Iframe caricato', 'success');
    
    setTimeout(function() {
        try {
            // Prova multiple strategie di injection
            if (frame.contentWindow) {
                frame.contentWindow.API = window.API;
                frame.contentWindow.API_1484_11 = window.API;
                log('API iniettata in contentWindow', 'success');
            }
            
            // Prova anche via postMessage
            frame.contentWindow.postMessage({
                type: 'SCORM_API_READY',
                api: 'available'
            }, '*');
            
        } catch(e) {
            log('Injection fallita: ' + e.message, 'error');
        }
    }, 100);
});

// Listener per messaggi dall'iframe
window.addEventListener('message', function(event) {
    if (event.data.type === 'SCORM_API_REQUEST') {
        log('Iframe richiede API', 'warning');
        event.source.postMessage({
            type: 'SCORM_API_RESPONSE',
            available: true
        }, '*');
    }
});

// Carica il contenuto
frame.src = SCORM_URL;
log('Caricamento SCORM da: ' + SCORM_URL, 'info');

// Cleanup
window.addEventListener('beforeunload', function() {
    if (window.API && window.API.initialized && !window.API.terminated) {
        window.API.LMSFinish('');
    }
});
</script>
</body>
</html>
